<!DOCTYPE html>
<html lang="en">
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level-Locked RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px 250px;
            gap: 20px;
        }
        
        .main-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }
        
        .player-stats {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat-bar {
            background: rgba(0, 0, 0, 0.3);
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .hp-fill { background: linear-gradient(90deg, #ff4757, #ff6b7a); }
        .xp-fill { background: linear-gradient(90deg, #3742fa, #5352ed); }
        
        .areas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .area-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .area-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .area-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .area-card.active {
            border-color: #3742fa;
            box-shadow: 0 0 20px rgba(55, 66, 250, 0.3);
        }
        
        .loot-box {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
        }
        
        .loot-box:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .loot-box:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .inventory {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-buttons {
            display: flex;
            gap: 5px;
        }
        
        .item-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .item-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .item-btn.equipped {
            background: linear-gradient(135deg, #2ed573, #17c0eb);
        }
        
        .shop {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #3498db;
        }
        
        .shop-item-info {
            flex: 1;
            font-size: 13px;
        }
        
        .shop-btn {
            background: linear-gradient(135deg, #2ed573, #17c0eb);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .shop-btn:hover {
            transform: scale(1.05);
        }
        
        .shop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .item.common { border-left-color: #95a5a6; }
        .item.rare { border-left-color: #3498db; }
        .item.epic { border-left-color: #9b59b6; }
        .item.legendary { border-left-color: #f39c12; }
        .item.mythic { border-left-color: #e74c3c; }
        
        .combat-area {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .enemy {
            background: rgba(255, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        .combat-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-entry.damage { color: #ff4757; }
        .log-entry.loot { color: #ffd700; }
        .log-entry.level { color: #2ed573; }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }
        
        .legendary-drop {
            animation: glow 2s infinite;
        }
    
#attack-btn {
    position: relative;
    transition: top 0.2s ease, left 0.2s ease;
}


@media (max-width: 768px) {
    body {
        font-size: 16px;
        padding: 8px;
    }

    .player-stats, .shop, .log, .inventory {
        width: 100% !important;
        padding: 10px;
        box-sizing: border-box;
    }

    .btn, .item-btn, .shop-btn {
        font-size: 1rem;
        padding: 10px 14px;
        margin: 4px 0;
        width: 100%;
    }

    .shop-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .shop-item-info {
        margin-bottom: 6px;
    }

    #npc-shop select, #trader-select {
        width: 100%;
        font-size: 1rem;
        padding: 8px;
    }
}

</style>

<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(() => {
      console.log('Service Worker Registered');
    });
  }
</script>

</head>
<body>
    <div class="game-container">
        <div class="main-area">
            <h1>‚öîÔ∏è Realm of Legends</h1>
            
            <div class="areas-grid">
                <div class="area-card" id="area-0">
                    <h3>üå± Peaceful Meadows</h3>
                    <p>Required Level: 1</p>
                    <p>Enemies: Slimes, Rabbits</p>
                </div>
                <div class="area-card locked" id="area-1">
                    <h3>üèîÔ∏è Rocky Hills</h3>
                    <p>Required Level: 5</p>
                    <p>Enemies: Goblins, Wolves</p>
                </div>
                <div class="area-card locked" id="area-2">
                    <h3>üå≤ Dark Forest</h3>
                    <p>Required Level: 12</p>
                    <p>Enemies: Orcs, Bears</p>
                </div>
                <div class="area-card locked" id="area-3">
                    <h3>üè∞ Ancient Ruins</h3>
                    <p>Required Level: 20</p>
                    <p>Enemies: Undead, Golems</p>
                </div>
                <div class="area-card locked" id="area-4">
                    <h3>üåã Infernal Depths</h3>
                    <p>Required Level: 35</p>
                    <p>Enemies: Demons, Dragons</p>
                </div>
            </div>
            
            <div class="combat-area">
                <div id="current-area">Select an area to begin your adventure!</div>
                <div id="enemy-display"></div>
                <div class="combat-buttons">
                    <button class="btn" id="attack-btn" onclick="attack()" disabled>‚öîÔ∏è Attack</button>
                    <button class="btn" id="flee-btn" onclick="flee()" disabled>üèÉ Flee</button>
                </div>
                <button class="loot-box" id="loot-box-btn" onclick="openLootBox()" disabled>
<div style="margin-top: 20px;">
  <button class="btn" onclick="saveGame()">üíæ Save Game</button>
  <button class="btn" onclick="loadGame()">üìÇ Load Game</button>
  <button class="btn" onclick="exportGame()">‚¨áÔ∏è Export Save</button>
  <input type="file" id="import-save-input" style="display:none" />
  <button class="btn" onclick="document.getElementById('import-save-input').click()">‚¨ÜÔ∏è Import Save</button>
</div>

                    üéÅ Open Loot Box (Cost: 100 Gold)
                </button>
            </div>
            
            <div class="log" id="combat-log"></div>
        </div>
        
        <div class="sidebar">
            <div class="player-stats">
                <h3>üë§ Hero Stats</h3>
                <div>Level: <span id="player-level">1</span></div>
                <div>Gold: <span id="player-gold">50</span></div>
                <div>Attack: <span id="player-attack">10</span></div>
                <div>Defense: <span id="player-defense">5</span></div>
                
                <div style="margin-top: 10px;">
                    <div>HP: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
                    <div class="stat-bar">
                        <div class="stat-fill hp-fill" id="hp-bar" style="width: 100%"></div>
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <div>XP: <span id="player-xp">0</span>/<span id="player-max-xp">100</span></div>
                    <div class="stat-bar">
                        <div class="stat-fill xp-fill" id="xp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="inventory">
                <h3>üéí Inventory</h3>
                <div id="inventory-list">
                    <div class="item common">Basic Sword (+5 Attack)</div>
                    <div class="item common">Cloth Armor (+3 Defense)</div>
                </div>
            </div>
        </div>
        
        
<div class="player-stats" style="margin-top: 20px;">
    <h3>üõ† Skills</h3>
    <div>Woodcutting: <span id="skill-woodcutting">1</span></div>
    <div>Mining: <span id="skill-mining">1</span></div>
    <div>Smithing: <span id="skill-smithing">1</span></div>
    <div>Crafting: <span id="skill-crafting">1</span></div>
    <div style="margin-top:10px;">
        <button class="btn" onclick="gainSkillXP('woodcutting')">üå≤ Chop Wood</button>
        <button class="btn" onclick="gainSkillXP('mining')">‚õè Mine</button>
        <button class="btn" onclick="gainSkillXP('smithing')">‚öí Smith</button>
        <button class="btn" onclick="gainSkillXP('crafting')">üé® Craft</button>
    
        <button class="btn" onclick="gainSkillXP('fishing')">üé£ Fish</button>
        <button class="btn" onclick="cookFish()">üî• Cook</button> 
<button class="btn" onclick="comboCook()">üçõ Combo Cook</button>


</div>
</div>



<div style="margin-top:20px;">
    <button class="btn" onclick="craftItem()">üé® Craft Gear</button>
    <button class="btn" onclick="smithItem()">‚öí Smith Weapon</button>
</div>



<div class="player-stats" style="margin-top: 20px;">
    <h3>üì¶ Resource Storage</h3>
    <div id="storage-list">
        <button class="btn" onclick="gainSkillXP('fishing')">üé£ Fish</button>
        <button class="btn" onclick="cookFish()">üî• Cook</button> 
<button class="btn" onclick="comboCook()">üçõ Combo Cook</button>


</div>
</div>


<div class="player-stats" style="margin-top: 20px;">
    <h3>üèõ Resource Trading Post</h3>
    <p style="font-size: 12px;">Trade 5x lower-tier resources for 1x higher-tier (next in category)</p>
    <button class="btn" onclick="openTradeMenu()">üîÑ Trade Resources</button>
    <div id="trade-results" style="margin-top:10px;">
        <button class="btn" onclick="gainSkillXP('fishing')">üé£ Fish</button>
        <button class="btn" onclick="cookFish()">üî• Cook</button> 
<button class="btn" onclick="comboCook()">üçõ Combo Cook</button>


</div>
</div>



<div class="player-stats" style="margin-top: 20px;">
    <h3>üßô Traders' Bazaar</h3>
    <select id="trader-select" onchange="switchTrader(this.value)">
        <option value="elric">Elric (General)</option>
        <option value="mira">Mira (Mystic)</option>
        <option value="grom">Grom (Warrior)</option>
    </select>
    <div id="npc-shop">
        <button class="btn" onclick="gainSkillXP('fishing')">üé£ Fish</button>
        <button class="btn" onclick="cookFish()">üî• Cook</button> 
<button class="btn" onclick="comboCook()">üçõ Combo Cook</button>


</div>
</div>


<div class="player-stats" style="margin-top: 20px;">
    <h3>üç≤ Active Buffs</h3>
    <ul id="buff-list"></ul>
</div>

<div class="shop">
            <h3>üè™ Shop</h3>
            <div id="shop-list">
                <!-- Shop items will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            player: {
                activeBuffs: [],
                storage: {
                    'Wood Log': 0,
                    'Hardwood Log': 0,
                    'Iron Ore': 0,
                    'Mithril Ore': 0,
                    'Copper Ore': 0,
                    'Oak Log': 0,
                    'Birch Log': 0,
                    'Maple Log': 0,
                    'Yew Log': 0,
                    'Ash Log': 0,
                    'Silver Ore': 0,
                    'Gold Ore': 0,
                    'Platinum Ore': 0,
                    'Obsidian Ore': 0,
                    'Ancient Bark': 0,
                    'Dragonwood': 0
                },
                skills: {
                    woodcutting: { level: 1, xp: 0, maxXp: 50 },
                    mining: { level: 1, xp: 0, maxXp: 50 },
                    smithing: { level: 1, xp: 0, maxXp: 50 },
                    crafting: { level: 1, xp: 0, maxXp: 50 }
                },
                level: 1,
                hp: 100,
                maxHp: 100,
                xp: 0,
                maxXp: 100,
                gold: 50,
                baseAttack: 10,
                baseDefense: 5,
                attack: 10,
                defense: 5
            },
            luckyCharms: 0,
            equipped: {
                weapon: null,
                armor: null,
                accessory: null
            },
            currentArea: null,
            currentEnemy: null,
            inCombat: false,
            inventory: [
                { id: 1, name: 'Basic Sword', type: 'weapon', rarity: 'common', stats: { attack: 5 }, value: 10 },
                { id: 2, name: 'Cloth Armor', type: 'armor', rarity: 'common', stats: { defense: 3 }, value: 8 }
            ]
        };

        // Area definitions
        const areas = [
            {
                name: 'Peaceful Meadows',
                boss: { name: 'Mega Slime', hp: 150, attack: 25, xp: 200, gold: 50, isBoss: true },
                level: 1,
                enemies: [
                    { name: 'Slime', hp: 30, attack: 8, xp: 15, gold: 10 },
                    { name: 'Rabbit', hp: 20, attack: 5, xp: 10, gold: 8 }
                ]
            },
            {
                name: 'Rocky Hills',
                level: 5,
                enemies: [
                    { name: 'Goblin', hp: 60, attack: 15, xp: 30, gold: 20 },
                    { name: 'Wolf', hp: 80, attack: 18, xp: 35, gold: 25 }
                ]
            },
            {
                name: 'Dark Forest',
                level: 12,
                enemies: [
                    { name: 'Orc', hp: 120, attack: 25, xp: 60, gold: 40 },
                    { name: 'Bear', hp: 150, attack: 30, xp: 70, gold: 50 }
                ]
            },
            {
                name: 'Ancient Ruins',
                level: 20,
                enemies: [
                    { name: 'Skeleton', hp: 200, attack: 40, xp: 100, gold: 80 },
                    { name: 'Stone Golem', hp: 300, attack: 45, xp: 120, gold: 100 }
                ]
            },
            {
                name: 'Infernal Depths',
                level: 35,
                enemies: [
                    { name: 'Demon', hp: 500, attack: 70, xp: 200, gold: 150 },
                    { name: 'Dragon', hp: 800, attack: 90, xp: 300, gold: 250 }
                ]
            }
        ];

        // Loot tables
        const lootTable = {
            common: [
                { name: 'Iron Sword', type: 'weapon', stats: { attack: 15 }, value: 30 },
                { name: 'Leather Armor', type: 'armor', stats: { defense: 10 }, value: 25 },
                { name: 'Health Potion', type: 'consumable', effect: 'heal', value: 50, price: 20 }
            ],
            rare: [
                { name: 'Steel Blade', type: 'weapon', stats: { attack: 25 }, value: 60 },
                { name: 'Chain Mail', type: 'armor', stats: { defense: 18 }, value: 50 },
                { name: 'Ring of Strength', type: 'accessory', stats: { attack: 10 }, value: 80 }
            ],
            epic: [
                { name: 'Enchanted Sword', type: 'weapon', stats: { attack: 40 }, value: 150 },
                { name: 'Plate Armor', type: 'armor', stats: { defense: 30 }, value: 120 },
                { name: 'Amulet of Power', type: 'accessory', stats: { attack: 15, defense: 10 }, value: 200 }
            ],
            legendary: [
                { name: 'Dragonbane', type: 'weapon', stats: { attack: 70 }, value: 500 },
                { name: 'Divine Aegis', type: 'armor', stats: { defense: 50 }, value: 400 },
                { name: 'Crown of Kings', type: 'accessory', stats: { attack: 25, defense: 25 }, value: 600 }
            ],
            mythic: [
                { name: 'Excalibur', type: 'weapon', stats: { attack: 100 }, value: 1000 },
                { name: 'Armor of Eternity', type: 'armor', stats: { defense: 80 }, value: 800 },
                { name: 'Heart of the Universe', type: 'accessory', stats: { attack: 50, defense: 50 }, value: 1200 }
            ]
        };
        
        // Shop items
        const shopItems = [

    { name: 'Minor Health Potion', type: 'consumable', effect: 'heal', value: 25, price: 30, description: 'Heals 25 HP' },
    { name: 'Major Health Potion', type: 'consumable', effect: 'heal', value: 75, price: 90, description: 'Heals 75 HP' },
    { name: 'Potion of Power', type: 'consumable', effect: 'buff', value: 0, price: 120, description: 'Grants Spicy Boost' },
    { name: 'Potion of Protection', type: 'consumable', effect: 'buff', value: 0, price: 120, description: 'Grants Fortified Skin' },
    { name: 'Potion of Wisdom', type: 'consumable', effect: 'buff', value: 0, price: 120, description: 'Grants Wisdom Stew' },


    { name: 'Stamina Drink', type: 'consumable', effect: 'stamina', value: 0, price: 50, description: 'Temporarily increases XP gain' },
    { name: 'Crafting Kit', type: 'consumable', effect: 'craftboost', value: 0, price: 75, description: 'Increases crafting success chance' },

            { name: 'Health Potion', type: 'consumable', effect: 'heal', value: 50, price: 20, description: 'Restores 50 HP' },
            { name: 'Super Health Potion', type: 'consumable', effect: 'heal', value: 150, price: 60, description: 'Restores 150 HP' },
            { name: 'Mega Health Potion', type: 'consumable', effect: 'heal', value: 300, price: 120, description: 'Restores 300 HP' },
            { name: 'Full Heal Potion', type: 'consumable', effect: 'fullheal', value: 0, price: 200, description: 'Restores all HP' },
            { name: 'Lucky Charm', type: 'consumable', effect: 'luck', value: 1, price: 500, description: 'Increases loot box drop rates for 5 boxes' }
        ];

        // Initialize game
        function init() {
            updateDisplay();
            updateAreas();
            updateShop();
            setupAreaClickHandlers();
        }

        function setupAreaClickHandlers() {
            for (let i = 0; i < areas.length; i++) {
                document.getElementById(`area-${i}`).addEventListener('click', () => selectArea(i));
            }
        }

        function selectArea(areaIndex) {
            const area = areas[areaIndex];
            if (gameState.player.level < area.level) {
                log(`You need to be level ${area.level} to enter ${area.name}!`, 'damage');
                return;
            }

            gameState.currentArea = areaIndex;
            updateAreas();
            spawnEnemy();
            document.getElementById('current-area').textContent = `Current Area: ${area.name}`;
            log(`Entered ${area.name}`, 'level');
        }

        
function spawnEnemy() {
    const area = areas[gameState.currentArea];

    let enemy;
    // 10% chance for boss encounter
    if (Math.random() < 0.1 && area.boss) {
        enemy = { ...area.boss };
        log(`‚ö†Ô∏è BOSS ENCOUNTER: ${enemy.name} appears!`, 'level');
    } else {
        enemy = { ...area.enemies[Math.floor(Math.random() * area.enemies.length)] };
    }

    gameState.currentEnemy = enemy;
    gameState.inCombat = true;

    updateEnemyDisplay();
    document.getElementById('attack-btn').disabled = false;
    document.getElementById('flee-btn').disabled = false;
}
;
            gameState.currentEnemy = enemy;
            gameState.inCombat = true;
            
            updateEnemyDisplay();
            document.getElementById('attack-btn').disabled = false;
            document.getElementById('flee-btn').disabled = false;
        }

        
function attack() {
    // Move the attack button slightly to dodge bots
    const attackBtn = document.getElementById('attack-btn');
    const offsetX = Math.floor(Math.random() * 60) - 30;
    const offsetY = Math.floor(Math.random() * 60) - 30;
    attackBtn.style.left = offsetX + 'px';
    attackBtn.style.top = offsetY + 'px';

    if (!gameState.inCombat || !gameState.currentEnemy) return;

    const enemy = gameState.currentEnemy;

    log(`‚öîÔ∏è You engage ${enemy.name} in battle!`, 'level');

    while (enemy.hp > 0 && gameState.player.hp > 0) {
        // Player attacks
        const playerDamage = Math.max(1, gameState.player.attack - Math.floor(Math.random() * 5));
        enemy.hp -= playerDamage;
        log(`You deal ${playerDamage} damage to ${enemy.name}!`, 'damage');

        if (enemy.hp <= 0) break;

        // Enemy attacks
        const enemyDamage = Math.max(1, enemy.attack - gameState.player.defense - Math.floor(Math.random() * 3));
        gameState.player.hp -= enemyDamage;
        log(`${enemy.name} deals ${enemyDamage} damage to you!`, 'damage');

        if (gameState.player.hp <= 0) {
            gameState.player.hp = 1;
            log('You barely survived! Fleeing to safety...', 'damage');
            flee();
            return;
        }
    }

    if (enemy.hp <= 0) {
        // Boss loot logic
        let bonusLoot = '';
        if (enemy.isBoss && Math.random() < 0.02) {
            if (Math.random() < 0.5) {
                const mythicLoot = lootTable.mythic.concat(lootTable.legendary);
                const drop = { ...mythicLoot[Math.floor(Math.random() * mythicLoot.length)] };
                drop.rarity = drop.rarity || 'mythic';
                drop.id = Date.now() + Math.random();
                gameState.inventory.push(drop);
                bonusLoot = ` üéâ BONUS DROP: ${drop.name} (${drop.rarity.toUpperCase()})`;
            } else {
                const bonusGold = Math.floor(500 + Math.random() * 500);
                gameState.player.gold += bonusGold;
                bonusLoot = ` üí∞ BONUS GOLD: +${bonusGold}`;
            }
        }

        const xpGain = enemy.xp;
        const goldGain = enemy.gold;
        gameState.player.xp += xpGain;
        gameState.player.gold += goldGain;

        log(`${enemy.name} defeated! +${xpGain} XP, +${goldGain} Gold${bonusLoot}`, 'loot');
    processBuffs();
    incrementActionCounter();

        checkLevelUp();
        endCombat();
        setTimeout(spawnEnemy, 1000);
    }

    updateEnemyDisplay();
    updateDisplay();
}

    }

                
                log(`${gameState.currentEnemy.name} defeated! +${xpGain} XP, +${goldGain} Gold`, 'loot');
                
                checkLevelUp();
                endCombat();
                setTimeout(spawnEnemy, 1000);
                return;
            }

            // Enemy attacks player
            const enemyDamage = Math.max(1, gameState.currentEnemy.attack - gameState.player.defense - Math.floor(Math.random() * 3));
            gameState.player.hp -= enemyDamage;
            log(`${gameState.currentEnemy.name} deals ${enemyDamage} damage to you!`, 'damage');

            if (gameState.player.hp <= 0) {
                gameState.player.hp = 1;
                log('You barely survived! Fleeing to safety...', 'damage');
                flee();
                return;
            }

            updateEnemyDisplay();
            updateDisplay();
        }

        function flee() {
            log('You fled from combat!', 'level');
            endCombat();
        }

        function endCombat() {
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            document.getElementById('attack-btn').disabled = true;
            document.getElementById('flee-btn').disabled = true;
            document.getElementById('enemy-display').innerHTML = '';
        }

        function checkLevelUp() {
            while (gameState.player.xp >= gameState.player.maxXp) {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.maxXp;
                gameState.player.maxXp = Math.floor(gameState.player.maxXp * 1.5);
                
                // Level up bonuses
                gameState.player.maxHp += 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.baseAttack += 3;
                gameState.player.baseDefense += 2;
                
                updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
                log(`LEVEL UP! You are now level ${gameState.player.level}!`, 'level');
                updateAreas();
            }
        }

        function openLootBox() {
            if (gameState.player.gold < 100) {
                log('Not enough gold for loot box!', 'damage');
                return;
            }

            gameState.player.gold -= 100;
            
            // Determine rarity (with lucky charm bonus)
            let roll = Math.random();
            
            // Lucky charm effect
            if (gameState.luckyCharms > 0) {
                roll = Math.min(roll * 0.7, 0.97); // Better odds, but cap at 97% to ensure mythic is still possible
                gameState.luckyCharms--;
                log(`Lucky charm used! ${gameState.luckyCharms} remaining`, 'level');
            }
            
            let rarity;
            if (roll < 0.45) rarity = 'common';
            else if (roll < 0.75) rarity = 'rare';
            else if (roll < 0.90) rarity = 'epic';
            else if (roll < 0.98) rarity = 'legendary';
            else rarity = 'mythic';

            const items = lootTable[rarity];
            const item = {...items[Math.floor(Math.random() * items.length)]};
            item.rarity = rarity;
            item.id = Date.now() + Math.random(); // Unique ID

            gameState.inventory.push(item);
            
            const rarityColors = {
                common: '#95a5a6',
                rare: '#3498db',
                epic: '#9b59b6',
                legendary: '#f39c12',
                mythic: '#e74c3c'
            };

            log(`Found ${rarity.toUpperCase()} item: ${item.name}!`, 'loot');
            
            if (rarity === 'legendary' || rarity === 'mythic') {
                document.getElementById('loot-box-btn').classList.add('legendary-drop');
                setTimeout(() => {
                    document.getElementById('loot-box-btn').classList.remove('legendary-drop');
                }, 2000);
            }

            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            document.getElementById('player-attack').textContent = gameState.player.attack;
            document.getElementById('player-defense').textContent = gameState.player.defense;
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('player-xp').textContent = gameState.player.xp;
            document.getElementById('player-max-xp').textContent = gameState.player.maxXp;
            
            document.getElementById('hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            document.getElementById('xp-bar').style.width = `${(gameState.player.xp / gameState.player.maxXp) * 100}%`;
            
            document.getElementById('loot-box-btn').disabled = gameState.player.gold < 100;
            
            // Update lucky charms display
            if (gameState.luckyCharms > 0) {
                document.getElementById('loot-box-btn').textContent = `üéÅ Open Loot Box (Cost: 100 Gold) üçÄ${gameState.luckyCharms}`;
            } else {
                document.getElementById('loot-box-btn').textContent = 'üéÅ Open Loot Box (Cost: 100 Gold)';
            }
            
            updateShop();
        }

        function updateAreas() {
            for (let i = 0; i < areas.length; i++) {
                const areaElement = document.getElementById(`area-${i}`);
                const area = areas[i];
                
                if (gameState.player.level >= area.level) {
                    areaElement.classList.remove('locked');
                    if (gameState.currentArea === i) {
                        areaElement.classList.add('active');
                    } else {
                        areaElement.classList.remove('active');
                    }
                } else {
                    areaElement.classList.add('locked');
                    areaElement.classList.remove('active');
                }
            }
        }

        function updateEnemyDisplay() {
            if (!gameState.currentEnemy) return;
            
            const enemy = gameState.currentEnemy;
            
const bossTag = enemy.isBoss ? '<strong style="color:#e74c3c;">(Boss)</strong>' : '';
document.getElementById('enemy-display').innerHTML = `
    <div class="enemy">
        <h3>${enemy.name} ${bossTag}</h3>
        <div>HP: ${enemy.hp}</div>
        <div>Attack: ${enemy.attack}</div>
    </div>
`;

        }

        function updateInventory() {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            gameState.inventory.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `item ${item.rarity}`;
                
                let statsText = '';
                if (item.stats) {
                    const statStrings = [];
                    if (item.stats.attack) statStrings.push(`+${item.stats.attack} Attack`);
                    if (item.stats.defense) statStrings.push(`+${item.stats.defense} Defense`);
                    statsText = ` (${statStrings.join(', ')})`;
                }
                
                const itemInfo = document.createElement('div');
                itemInfo.className = 'item-info';
                itemInfo.textContent = item.name + statsText;
                
                const itemButtons = document.createElement('div');
                itemButtons.className = 'item-buttons';
                
                // Equip/Unequip button for equipment
                if (item.type === 'weapon' || item.type === 'armor' || item.type === 'accessory') {
                    const equipBtn = document.createElement('button');
                    equipBtn.className = 'item-btn';
                    
                    const isEquipped = gameState.equipped[item.type] && gameState.equipped[item.type].id === item.id;
                    
                    if (isEquipped) {
                        equipBtn.textContent = 'Unequip';
                        equipBtn.classList.add('equipped');
                        equipBtn.onclick = () => unequipItem(item);
                    } else {
                        equipBtn.textContent = 'Equip';
                        equipBtn.onclick = () => equipItem(item);
                    }
                    
                    itemButtons.appendChild(equipBtn);
                }
                
                // Use button for consumables
                if (item.type === 'consumable') {
                    const useBtn = document.createElement('button');
                    useBtn.className = 'item-btn';
                    useBtn.textContent = 'Use';
                    useBtn.onclick = () => useItem(item);
                    itemButtons.appendChild(useBtn);
                }
                
                // Sell button for all items (including materials)

if (item.type === 'material') {
    const depositBtn = document.createElement('button');
    depositBtn.className = 'item-btn';
    depositBtn.textContent = 'Deposit';
    depositBtn.onclick = () => depositMaterial(item);
    itemButtons.appendChild(depositBtn);
}

                const sellBtn = document.createElement('button');
                sellBtn.className = 'item-btn sell-btn';
                sellBtn.textContent = `Sell (${item.value || 1}g)`;
                sellBtn.onclick = () => sellItem(item);
                
                // Allow selling all items regardless of equip status
                const isEquipped = gameState.equipped[item.type] && gameState.equipped[item.type].id === item.id;
                if (isEquipped) {
                    const sameTypeCount = gameState.inventory.filter(i => i.type === item.type).length;
                    if (sameTypeCount === 1) {
                        sellBtn.disabled = true;
                        sellBtn.title = "Cannot sell - equip another item first";
                    }
                }
                
                itemButtons.appendChild(sellBtn);
                
                itemDiv.appendChild(itemInfo);
                itemDiv.appendChild(itemButtons);
                inventoryList.appendChild(itemDiv);
            });
        }
        
        function equipItem(item) {
            // Unequip current item of same type if any
            if (gameState.equipped[item.type]) {
                unequipItem(gameState.equipped[item.type]);
            }
            
            gameState.equipped[item.type] = item;
            updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
            log(`Equipped ${item.name}!`, 'level');
        }
        
        function unequipItem(item) {
            gameState.equipped[item.type] = null;
            updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
            log(`Unequipped ${item.name}!`, 'level');
        }
        
        
            }
        }
        
        function sellItem(item) {
            const sellPrice = item.value || 1;
            
            // If item is equipped, unequip it first
            if (gameState.equipped[item.type] && gameState.equipped[item.type].id === item.id) {
                gameState.equipped[item.type] = null;
                updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            }
            
            // Remove from inventory and add gold
            gameState.inventory = gameState.inventory.filter(i => i.id !== item.id);
            gameState.player.gold += sellPrice;
            
            lastSoldItem = item;
    log(`Sold ${item.name} for ${sellPrice} gold`, 'loot');
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
        }
        
        function buyItem(shopItem) {
            if (gameState.player.gold < shopItem.price) {
                log('Not enough gold!', 'damage');
                return;
            }
            
            gameState.player.gold -= shopItem.price;
            
            const newItem = {...shopItem};
            newItem.id = Date.now() + Math.random();
            newItem.rarity = 'common';
            
            gameState.inventory.push(newItem);
            
            log(`Bought ${shopItem.name} for ${shopItem.price} gold`, 'loot');
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
            updateShop();
        }
        
        function updateShop() {
            const shopList = document.getElementById('shop-list');
            shopList.innerHTML = '';
            
            shopItems.forEach(shopItem => {
                const shopDiv = document.createElement('div');
                shopDiv.className = 'shop-item';
                
                const shopInfo = document.createElement('div');
                shopInfo.className = 'shop-item-info';
                shopInfo.innerHTML = `
                    <div style="font-weight: bold;">${shopItem.name}</div>
                    <div style="font-size: 11px; opacity: 0.8;">${shopItem.description}</div>
                    <div style="font-size: 12px; color: #ffd700;">${shopItem.price} Gold</div>
                `;
                
                const buyBtn = document.createElement('button');
                buyBtn.className = 'shop-btn';
                buyBtn.textContent = 'Buy';
                buyBtn.disabled = gameState.player.gold < shopItem.price;
                buyBtn.onclick = () => buyItem(shopItem);
                
                shopDiv.appendChild(shopInfo);
                shopDiv.appendChild(buyBtn);
                shopList.appendChild(shopDiv);
            });
        }
        
        function updatePlayerStats() {
            // Calculate stats with equipment bonuses
            let attackBonus = 0;
            let defenseBonus = 0;
            
            Object.values(gameState.equipped).forEach(item => {
                if (item && item.stats) {
                    if (item.stats.attack) attackBonus += item.stats.attack;
                    if (item.stats.defense) defenseBonus += item.stats.defense;
                }
            });
            
            gameState.player.attack = gameState.player.baseAttack + attackBonus;
            gameState.player.defense = gameState.player.baseDefense + defenseBonus;
        }

        function log(message, type = '') {
            const logDiv = document.getElementById('combat-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }

        // Start the game
        function startGame() {
            updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            init();
        }
        
        updateNpcShops();
        startGame();
    
function saveGame() {
    localStorage.setItem('realmOfLegendsSave', JSON.stringify(gameState));
    log('Game saved!', 'level');
}

function loadGame() {
    const saved = localStorage.getItem('realmOfLegendsSave');
    if (saved) {
        gameState = JSON.parse(saved);
        updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
        updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
        updateDisplay();
        updateAreas();
        log('Game loaded!', 'level');
    } else {
        log('No save found.', 'damage');
    }
}

function exportGame() {
    const dataStr = JSON.stringify(gameState, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = "RealmOfLegends_Save.json";
    a.click();
    URL.revokeObjectURL(url);

    log('Save exported!', 'level');
}

document.getElementById('import-save-input').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
        try {
            const importedState = JSON.parse(event.target.result);
            gameState = importedState;
            updatePlayerStats();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateInventory();
    updateStorageDisplay();
    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
            updateDisplay();
            updateAreas();
            log('Save imported successfully!', 'level');
        } catch (err) {
            log('Failed to import save.', 'damage');
        }
    };
    reader.readAsText(file);
});


function gainSkillXP(skill) {
    const sk = gameState.player.skills[skill];
    const xpGain = Math.floor(Math.random() * 10) + 5;
    sk.xp += xpGain;
    log(`Gained ${xpGain} ${skill} XP`, 'level');
    incrementActionCounter();

    if (sk.xp >= sk.maxXp) {
        sk.level++;
        sk.xp -= sk.maxXp;
        sk.maxXp = Math.floor(sk.maxXp * 1.5);
        log(`${skill.charAt(0).toUpperCase() + skill.slice(1)} leveled up to ${sk.level}!`, 'level');
    }

    
    
    
    const woodcuttingTable = [
        { name: 'Wood Log', level: 1, value: 5 },
        { name: 'Oak Log', level: 5, value: 10 },
        { name: 'Birch Log', level: 10, value: 12 },
        { name: 'Maple Log', level: 15, value: 14 },
        { name: 'Yew Log', level: 20, value: 16 },
        { name: 'Ash Log', level: 25, value: 18 },
        { name: 'Ancient Bark', level: 30, value: 30 },
        { name: 'Dragonwood', level: 40, value: 50 }
    ];

    const miningTable = [
        { name: 'Copper Ore', level: 1, value: 6 },
        { name: 'Iron Ore', level: 5, value: 8 },
        { name: 'Silver Ore', level: 10, value: 12 },
        { name: 'Gold Ore', level: 15, value: 16 },
        { name: 'Platinum Ore', level: 20, value: 20 },
        { name: 'Mithril Ore', level: 25, value: 25 },
        { name: 'Obsidian Ore', level: 30, value: 35 }
    ];

    function getResourceFromTable(table, skillLevel) {
        const unlocked = table.filter(r => skillLevel >= r.level);
        return unlocked[Math.floor(Math.random() * unlocked.length)];
    }

    if (skill === 'woodcutting') {
        const item = getResourceFromTable(woodcuttingTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'woodcutting'
        });
        log(`Found material: ${item.name}!`, 'loot');

    } else if (skill === 'mining') {
        const item = getResourceFromTable(miningTable, sk.level);
        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: 'mining'
        });
        log(`Found material: ${item.name}!`, 'loot');
    }

    updateSkillsDisplay();
    updateDisplay();
}

function updateSkillsDisplay() {
    const skills = gameState.player.skills;
    document.getElementById('skill-woodcutting').textContent = skills.woodcutting.level;
    document.getElementById('skill-mining').textContent = skills.mining.level;
    document.getElementById('skill-smithing').textContent = skills.smithing.level;
    document.getElementById('skill-crafting').textContent = skills.crafting.level;
}




function craftItem() {
    const skills = gameState.player.skills;
    let logCount = countMaterial('Wood Log') + countMaterial('Hardwood Log') + getStored('Wood Log') + getStored('Hardwood Log');

    if (logCount < 2) {
        log('Need at least 2 logs (inventory or storage) to craft gear!', 'damage');
        return;
    }

    removeMaterials(['Hardwood Log', 'Wood Log'], 2);

    let gear;
    if (skills.crafting.level >= 10) {
        gear = {
            id: Date.now() + Math.random(),
            name: 'Hardwood Armor',
            type: 'armor',
            rarity: 'rare',
            stats: { defense: 18 },
            value: 45
        };
    } else {
        gear = {
            id: Date.now() + Math.random(),
            name: 'Wooden Shield',
            type: 'armor',
            rarity: 'common',
            stats: { defense: 8 },
            value: 20
        };
    }

    gameState.inventory.push(gear);
    log(`Crafted ${gear.name}!`, 'loot');
    incrementActionCounter();
    updateInventory();
    updateDisplay();
}


    removeMaterials(['Mithril Ore', 'Iron Ore'], 2);

    let weapon;
    if (skills.smithing.level >= 10) {
        weapon = {
            id: Date.now() + Math.random(),
            name: 'Mithril Sword',
            type: 'weapon',
            rarity: 'rare',
            stats: { attack: 28 },
            value: 60
        };
    } else {
        weapon = {
            id: Date.now() + Math.random(),
            name: 'Iron Sword',
            type: 'weapon',
            rarity: 'common',
            stats: { attack: 12 },
            value: 25
        };
    }

    gameState.inventory.push(weapon);
    log(`Forged ${weapon.name}!`, 'loot');
    incrementActionCounter();
    updateInventory();
    updateDisplay();
}

function countMaterial(name) {
    return gameState.inventory.filter(i => i.name === name).length;
}

function getStored(name) {
    return gameState.player.storage[name] || 0;
}

function removeMaterials(names, count) {
    for (let name of names) {
        while (count > 0 && gameState.inventory.some(i => i.name === name)) {
            const index = gameState.inventory.findIndex(i => i.name === name);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                count--;
            }
        }
    }

    for (let name of names) {
        while (count > 0 && gameState.player.storage[name] > 0) {
            gameState.player.storage[name]--;
            count--;
        }
    }
}

function smithItem() {
    const ores = gameState.inventory.filter(i => i.name === 'Iron Ore');
    if (ores.length < 2) {
        log('Need at least 2 Iron Ores to smith a weapon!', 'damage');
        return;
    }

    // Remove used ores
    gameState.inventory = gameState.inventory.filter(i => i.name !== 'Iron Ore' || --ores.length < 2);

    const weapon = {
        id: Date.now() + Math.random(),
        name: 'Iron Sword',
        type: 'weapon',
        rarity: 'common',
        stats: { attack: 12 },
        value: 25
    };
    gameState.inventory.push(weapon);
    log('Forged Iron Sword!', 'loot');
    updateInventory();
    updateStorageDisplay();
    updateDisplay();
}


function depositMaterial(item) {
    if (!gameState.player.storage[item.name]) {
        gameState.player.storage[item.name] = 0;
    }
    gameState.player.storage[item.name]++;
    gameState.inventory = gameState.inventory.filter(i => i.id !== item.id);
    log(`Deposited 1 ${item.name} into storage.`, 'level');
    updateInventory();
    updateStorageDisplay();
    updateStorageDisplay();
    updateDisplay();
}

function updateStorageDisplay() {
    for (const mat in gameState.player.storage) {
        const el = document.getElementById(`storage-${mat}`);
        if (el) {
            el.textContent = gameState.player.storage[mat];
        }
    }
}


function withdrawMaterial(name) {
    if (!gameState.player.storage[name] || gameState.player.storage[name] <= 0) {
        log(`No ${name} in storage to withdraw.`, 'damage');
        return;
    }

    gameState.player.storage[name]--;
    gameState.inventory.push({
        id: Date.now() + Math.random(),
        name: name,
        type: 'material',
        rarity: 'common',
        value: 5 + Math.floor(Math.random() * 10),
        source: 'storage'
    });

    log(`Withdrew 1 ${name} from storage.`, 'level');
    updateInventory();
    updateStorageDisplay();
    updateDisplay();
}


function updateStorageDisplay() {
    const container = document.getElementById('storage-list');
    container.innerHTML = '';

    const values = {
        'Wood Log': 5,
        'Hardwood Log': 15,
        'Iron Ore': 8,
        'Mithril Ore': 20,
        'Copper Ore': 6,
        'Oak Log': 10
    };

    for (const mat in gameState.player.storage) {
        const amount = gameState.player.storage[mat] || 0;
        const value = values[mat] || 1;

        const row = document.createElement('div');
        row.style.marginBottom = '6px';

        row.innerHTML = `
            ${mat}: <strong>${amount}</strong> 
            <span style="color:gold;">(Value: ${value}g each)</span>
            <button class="item-btn" style="margin-left:10px;" onclick="withdrawMaterial('${mat}')">Withdraw</button>
        `;

        container.appendChild(row);
    }
}


function openTradeMenu() {
    const results = document.getElementById('trade-results');
    results.innerHTML = '';

    const tradeChains = [
        ['Wood Log', 'Oak Log', 'Birch Log', 'Maple Log', 'Yew Log', 'Ash Log', 'Ancient Bark', 'Dragonwood'],
        ['Copper Ore', 'Iron Ore', 'Silver Ore', 'Gold Ore', 'Platinum Ore', 'Mithril Ore', 'Obsidian Ore']
    ];

    for (const chain of tradeChains) {
        for (let i = 0; i < chain.length - 1; i++) {
            const lower = chain[i];
            const higher = chain[i + 1];
            const available = gameState.player.storage[lower] || 0;

            if (available >= 5) {
                const tradeBtn = document.createElement('button');
                tradeBtn.className = 'item-btn';
                tradeBtn.textContent = `Trade 5 ${lower} ‚Üí 1 ${higher}`;
                tradeBtn.onclick = () => {
                    gameState.player.storage[lower] -= 5;
                    gameState.player.storage[higher] = (gameState.player.storage[higher] || 0) + 1;
                    log(`Traded 5 ${lower} for 1 ${higher}`, 'level');
        incrementActionCounter();
                    updateStorageDisplay();
                    openTradeMenu();
                };
                results.appendChild(tradeBtn);
                results.appendChild(document.createElement('br'));
            }
        }
    }

    if (!results.hasChildNodes()) {
        results.textContent = 'No eligible trades available.';
    }
}


let playerActions = 0;

const npcStockPool = [
    { name: 'Stamina Drink', type: 'consumable', effect: 'stamina', value: 0, price: 60, description: 'Boosts XP gain' },
    { name: 'Crafting Kit', type: 'consumable', effect: 'craftboost', value: 0, price: 75, description: 'Boosts crafting success' },
    { name: 'Mystery Box', type: 'consumable', effect: 'random', value: 0, price: 100, description: '???"' },
    { name: 'Refining Stone', type: 'consumable', effect: 'refine', value: 0, price: 120, description: 'Improves weapon stats' },
    { name: 'Ancient Scroll', type: 'consumable', effect: 'enchant', value: 0, price: 150, description: 'Grants random buff' },
    { name: 'Minor Health Potion', type: 'consumable', effect: 'heal', value: 30, price: 15, description: 'Heals 30 HP' },
    { name: 'Forge Token', type: 'consumable', effect: 'forgeboost', value: 0, price: 90, description: 'Improves smithing yield' }
];

let npcShopItems = [];

function incrementActionCounter() {
    playerActions++;
    if (playerActions >= 10) {
        updateNpcShops();
        playerActions = 0;
    }
}

function updateNpcShop() {
    npcShopItems = [];
    const pool = [...npcStockPool];
    while (npcShopItems.length < 3 && pool.length > 0) {
        const index = Math.floor(Math.random() * pool.length);
        npcShopItems.push(pool.splice(index, 1)[0]);
    }
    drawNpcShop();
}

function drawNpcShop() {
    const container = document.getElementById('npc-shop');
    container.innerHTML = '';
    npcShopItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';
        const info = document.createElement('div');
        info.className = 'shop-item-info';
        info.innerHTML = `
            <strong>${item.name}</strong><br>
            <small>${item.description}</small><br>
            <span style="color: gold;">${item.price}g</span>
        `;

        const buyBtn = document.createElement('button');
        buyBtn.className = 'shop-btn';
        buyBtn.textContent = 'Buy';
        buyBtn.disabled = gameState.player.gold < item.price;
        buyBtn.onclick = () => {
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                const newItem = { ...item, id: Date.now() + Math.random(), rarity: 'common' };
                gameState.inventory.push(newItem);
                log(`Bought ${item.name} from Trader Elric`, 'loot');
                updateInventory();
                updateDisplay();
                drawNpcShop();
            }
        };

        itemDiv.appendChild(info);
        itemDiv.appendChild(buyBtn);
        container.appendChild(itemDiv);
    });
}


let playerActions = 0;
let lastSoldItem = null;
let currentTrader = 'elric';

const traderPools = {
    elric: {
        name: 'Elric',
        type: 'General',
        pool: [
            { name: 'Stamina Drink', rarity: 'common', price: 60, description: 'Boosts XP gain' },
            { name: 'Crafting Kit', rarity: 'common', price: 75, description: 'Boosts crafting success' },
            { name: 'Minor Health Potion', rarity: 'common', price: 15, description: 'Heals 30 HP' },
            { name: 'Forge Token', rarity: 'rare', price: 90, description: 'Improves smithing yield' }
        ]
    },
    mira: {
        name: 'Mira',
        type: 'Mystic',
        pool: [
            { name: 'Ancient Scroll', rarity: 'rare', price: 150, description: 'Grants random buff' },
            { name: 'Mystery Box', rarity: 'rare', price: 100, description: '???' },
            { name: 'Wand Fragment', rarity: 'epic', price: 300, description: 'Mystic component' }
        ]
    },
    grom: {
        name: 'Grom',
        type: 'Warrior',
        pool: [
            { name: 'Battle Potion', rarity: 'common', price: 50, description: 'Boosts attack' },
            { name: 'Sharpening Stone', rarity: 'rare', price: 120, description: 'Improves weapon stats' },
            { name: 'Hero Medal', rarity: 'epic', price: 400, description: 'Increases all stats' }
        ]
    }
};

let npcShopItems = {};

function switchTrader(traderId) {
    currentTrader = traderId;
    drawNpcShop();
}

function incrementActionCounter() {
    playerActions++;
    if (playerActions >= 10) {
        updateNpcShops();
        playerActions = 0;
    }
}

function updateNpcShops() {
    for (const traderId in traderPools) {
        const pool = [...traderPools[traderId].pool];
        npcShopItems[traderId] = [];
        while (npcShopItems[traderId].length < 3 && pool.length > 0) {
            const index = Math.floor(Math.random() * pool.length);
            npcShopItems[traderId].push(pool.splice(index, 1)[0]);
        }
    }
    drawNpcShop();
}

function drawNpcShop() {
    const container = document.getElementById('npc-shop');
    container.innerHTML = '';

    const items = npcShopItems[currentTrader] || [];
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';
        const info = document.createElement('div');
        info.className = 'shop-item-info';
        info.innerHTML = `
            <strong>${item.name} [${item.rarity}]</strong><br>
            <small>${item.description}</small><br>
            <span style="color: gold;">${item.price}g</span>
        `;

        const buyBtn = document.createElement('button');
        buyBtn.className = 'shop-btn';
        buyBtn.textContent = 'Buy';
        buyBtn.disabled = gameState.player.gold < item.price;
        buyBtn.onclick = () => {
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                const newItem = { ...item, type: 'consumable', id: Date.now() + Math.random(), value: 0 };
                gameState.inventory.push(newItem);
                log(`Bought ${item.name} from Trader ${traderPools[currentTrader].name}`, 'loot');
                updateInventory();
                updateDisplay();
                drawNpcShop();
            }
        };

        itemDiv.appendChild(info);
        itemDiv.appendChild(buyBtn);
        container.appendChild(itemDiv);
    });

    if (lastSoldItem) {
        const buybackDiv = document.createElement('div');
        buybackDiv.className = 'shop-item';
        buybackDiv.innerHTML = `<strong>üí∞ Buyback:</strong> ${lastSoldItem.name} for ${lastSoldItem.value}g`;
        const buybackBtn = document.createElement('button');
        buybackBtn.className = 'shop-btn';
        buybackBtn.textContent = 'Buy Back';
        buybackBtn.disabled = gameState.player.gold < lastSoldItem.value;
        buybackBtn.onclick = () => {
            if (gameState.player.gold >= lastSoldItem.value) {
                gameState.player.gold -= lastSoldItem.value;
                gameState.inventory.push(lastSoldItem);
                log(`Bought back ${lastSoldItem.name}`, 'loot');
                lastSoldItem = null;
                updateInventory();
                updateDisplay();
                drawNpcShop();
            }
        };
        buybackDiv.appendChild(buybackBtn);
        container.appendChild(buybackDiv);
    }
}


const fishingTable = [
    { name: 'Minnow', level: 1, value: 4 },
    { name: 'Trout', level: 5, value: 6 },
    { name: 'Salmon', level: 10, value: 8 },
    { name: 'Catfish', level: 15, value: 12 },
    { name: 'Tuna', level: 20, value: 15 },
    { name: 'Swordfish', level: 30, value: 20 },
    { name: 'Golden Carp', level: 40, value: 35 }
];

function getFish(skillLevel) {
    const available = fishingTable.filter(f => skillLevel >= f.level);
    return available[Math.floor(Math.random() * available.length)];
}

function gainSkillXP(skill) {
    const sk = gameState.player.skills[skill];
    const xpGain = Math.floor(Math.random() * 10) + 5;
    sk.xp += xpGain;
    log(`Gained ${xpGain} ${skill} XP`, 'level');

    if (sk.xp >= sk.maxXp) {
        sk.level++;
        sk.xp -= sk.maxXp;
        sk.maxXp = Math.floor(sk.maxXp * 1.5);
        log(`${skill.charAt(0).toUpperCase() + skill.slice(1)} leveled up to ${sk.level}!`, 'level');
    }

    if (skill === 'woodcutting' || skill === 'mining' || skill === 'fishing') {
        let item;
        if (skill === 'fishing') {
            item = getFish(sk.level);
        } else {
            const table = skill === 'woodcutting' ? woodcuttingTable : miningTable;
            item = getResourceFromTable(table, sk.level);
        }

        gameState.inventory.push({
            id: Date.now() + Math.random(),
            name: item.name,
            type: 'material',
            rarity: 'common',
            value: item.value,
            source: skill
        });

        log(`Found: ${item.name}`, 'loot');
    }

    updateSkillsDisplay();
    updateInventory();
    updateDisplay();
    incrementActionCounter();
}


function cookFish() {
    const cooking = gameState.player.skills.cooking;
    const rawFish = gameState.inventory.find(i => fishingTable.some(f => f.name === i.name));
    if (!rawFish) {
        log('No raw fish to cook!', 'damage');
        return;
    }

    gameState.inventory = gameState.inventory.filter(i => i.id !== rawFish.id);

    const buffs = [
        { stat: 'attack', name: 'Spicy Boost' },
        { stat: 'defense', name: 'Fortified Skin' },
        { stat: 'xp', name: 'Wisdom Stew' }
    ];
    const chosen = buffs[Math.floor(Math.random() * buffs.length)];

    const cooked = {
        id: Date.now() + Math.random(),
        name: 'Cooked ' + rawFish.name,
        type: 'consumable',
        effect: 'buff',
        value: 0,
        rarity: 'common',
        description: `Grants ${chosen.name}`
    };

    gameState.inventory.push(cooked);

    const xpGain = Math.floor(Math.random() * 10) + 8;
    cooking.xp += xpGain;
    log(`Cooked ${rawFish.name}, gained ${xpGain} cooking XP!`, 'level');

    if (cooking.xp >= cooking.maxXp) {
        cooking.level++;
        cooking.xp -= cooking.maxXp;
        cooking.maxXp = Math.floor(cooking.maxXp * 1.5);
        log(`Cooking leveled up to ${cooking.level}!`, 'level');
    }

    updateSkillsDisplay();
    updateInventory();
    updateDisplay();
    incrementActionCounter();
}


}

}


function applyBuff(name, stat, amount, duration = 10) {
    gameState.player.activeBuffs.push({ name, stat, amount, remaining: duration });
    log(`Buff applied: ${name} (+${amount} ${stat}) for ${duration} actions`, 'level');
    updateBuffDisplay();
}

function updateBuffDisplay() {
    const list = document.getElementById('buff-list');
    list.innerHTML = '';

    gameState.player.activeBuffs.forEach(buff => {
        const li = document.createElement('li');
        li.textContent = `${buff.name}: +${buff.amount} ${buff.stat} (${buff.remaining} turns)`;
        list.appendChild(li);
    });
}


function processBuffs() {
    gameState.player.activeBuffs = gameState.player.activeBuffs
        .map(buff => ({ ...buff, remaining: buff.remaining - 1 }))
        .filter(buff => buff.remaining > 0);
    updateBuffDisplay();

}


function comboCook() {
    const cooking = gameState.player.skills.cooking;
    const fish = gameState.inventory.filter(i => fishingTable.some(f => f.name === i.name));
    if (fish.length < 2) {
        log('Need at least 2 raw fish for a combo meal!', 'damage');
        return;
    }

    // Remove 2 fish
    const usedFish = fish.slice(0, 2);
    for (const f of usedFish) {
        gameState.inventory = gameState.inventory.filter(i => i.id !== f.id);
    }

    // Calculate quality
    const qualityMap = Object.fromEntries(fishingTable.map(f => [f.name, f.value]));
    const quality = usedFish.reduce((sum, f) => sum + (qualityMap[f.name] || 1), 0);

    const buffs = [
        { stat: 'attack', name: 'Spicy Boost' },
        { stat: 'defense', name: 'Fortified Skin' },
        { stat: 'xp', name: 'Wisdom Stew' }
    ];

    const buffCount = quality >= 40 ? 3 : quality >= 25 ? 2 : 1;
    const selectedBuffs = [];

    while (selectedBuffs.length < buffCount && buffs.length) {
        const index = Math.floor(Math.random() * buffs.length);
        selectedBuffs.push(buffs.splice(index, 1)[0]);
    }

    const cooked = {
        id: Date.now() + Math.random(),
        name: 'Gourmet Fish Platter',
        type: 'consumable',
        effect: 'comboBuff',
        value: 0,
        rarity: 'rare',
        description: `Grants ${selectedBuffs.map(b => b.name).join(', ')}`
    };

    // Store buffs in item
    cooked.comboBuffs = selectedBuffs.map(b => ({
        stat: b.stat,
        amount: Math.floor(quality / 5),
        duration: 10
    }));

    gameState.inventory.push(cooked);

    const xpGain = Math.floor(Math.random() * 15) + 15;
    cooking.xp += xpGain;
    log(`Cooked a Gourmet Platter! Gained ${xpGain} cooking XP!`, 'loot');

    if (cooking.xp >= cooking.maxXp) {
        cooking.level++;
        cooking.xp -= cooking.maxXp;
        cooking.maxXp = Math.floor(cooking.maxXp * 1.5);
        log(`Cooking leveled up to ${cooking.level}!`, 'level');
    }

    updateSkillsDisplay();
    updateInventory();
    updateDisplay();
    incrementActionCounter();
}

</script>

<div id="console" style="white-space: pre-wrap; font-family: monospace; font-size: 14px; color: #f66; background: #111; padding: 10px; margin-top: 10px; border-top: 2px solid #555;">
  <strong>Console Output:</strong>
</div>

</body>

<script>
  const origErr = console.error;
  const logEl = document.getElementById("console");
  console.error = (...args) => {
    origErr(...args);
    if (logEl) logEl.textContent += "\n" + args.join(" ");
  };
  window.onerror = function (message, source, lineno, colno, error) {
    if (logEl) logEl.textContent += `\nError: ${message} at ${source}:${lineno}`;
  };
</script>

</html>